<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />
  <title>SJAFB — Vehicle Inspection Manager</title>
  <meta name="theme-color" content="#2563eb" />

  <!-- Tailwind (mobile-first UI) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Calendar cell */
    .calendar-day { width:14.28%; height:84px; border:1px solid #e5e7eb; display:flex; flex-direction:column; justify-content:flex-start; align-items:flex-start; padding:4px; font-size:12px; position:relative; }
    .calendar-day .count { position:absolute; right:4px; bottom:4px; font-size:10px; background:#2563eb; color:#fff; border-radius:9999px; padding:0 6px; }
    .calendar-day.today { outline:2px solid #2563eb; }
    details > summary { cursor:pointer; }
    .thumb { width:80px; height:80px; object-fit:cover; border-radius:0.5rem; }
  </style>

  <!-- Inline PWA Manifest (we’ll turn this JSON into a real manifest at runtime) -->
  <script type="application/json" id="inline-manifest-json">
  {
    "name": "Vehicle Inspection Manager",
    "short_name": "Inspections",
    "start_url": ".",
    "display": "standalone",
    "background_color": "#ffffff",
    "theme_color": "#2563eb",
    "icons": [
      {
        "src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAE6UlEQVR4nO...",
        "sizes": "192x192",
        "type": "image/png",
        "purpose": "any maskable"
      },
      {
        "src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAYAAAD0eNT6AAANnUlEQVR4nO...",
        "sizes": "512x512",
        "type": "image/png",
        "purpose": "any maskable"
      }
    ]
  }
  </script>
</head>

<body class="bg-slate-50 text-slate-900">
  <div class="max-w-full mx-auto p-4 space-y-4">
    <!-- Header -->
    <header class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <h1 class="text-xl sm:text-2xl font-bold">Vehicle Inspection Manager</h1>
      <div class="flex items-center gap-2 flex-wrap">
        <label class="text-sm">Current User</label>
        <select id="currentUser" class="border rounded px-2 py-1"></select>
        <span id="roleBadge" class="text-xs px-2 py-1 rounded bg-slate-200">Role: -</span>
        <button id="exportBtn" class="px-3 py-2 rounded-xl bg-slate-900 text-white">Backup</button>
        <label class="px-3 py-2 rounded-xl bg-slate-200 cursor-pointer">Restore
          <input id="importInput" type="file" accept="application/json" class="hidden" />
        </label>
      </div>
    </header>

    <!-- Tabs -->
    <nav class="flex gap-2 overflow-x-auto">
      <button data-tab="tabCalendar" class="tabbtn px-3 py-2 rounded-xl bg-indigo-600 text-white">Calendar</button>
      <button data-tab="tabVehicles" class="tabbtn px-3 py-2 rounded-xl bg-white shadow">Vehicles</button>
      <button data-tab="tabOrganizations" class="tabbtn px-3 py-2 rounded-xl bg-white shadow">Organizations</button>
      <button data-tab="tabPersonnel" class="tabbtn px-3 py-2 rounded-xl bg-white shadow">Personnel</button>
      <button data-tab="tabInspections" class="tabbtn px-3 py-2 rounded-xl bg-white shadow">Inspections</button>
      <button data-tab="tabBrowser" class="tabbtn px-3 py-2 rounded-xl bg-white shadow">Browser</button>
    </nav>

    <!-- Calendar Tab -->
    <section id="tabCalendar" class="tab p-0 sm:p-2">
      <div class="bg-white rounded-xl shadow p-4">
        <div class="flex items-center justify-between mb-2">
          <h2 class="font-semibold text-lg">Years (2025–2045)</h2>
          <button id="toggleYearsBtn" class="px-3 py-1 text-sm bg-indigo-600 text-white rounded">Expand All Years</button>
        </div>
        <p class="text-xs text-slate-600 mb-2">Tap a year to expand its calendar. Days with inspections show a count; tap to view the day's inspections.</p>
        <div id="yearsAccordion" class="space-y-3"></div>
      </div>
    </section>

    <!-- Vehicles Tab -->
    <section id="tabVehicles" class="tab hidden">
      <div class="bg-white rounded-xl shadow p-4 space-y-4">
        <h2 class="font-semibold text-lg">Vehicles</h2>
        <div class="flex gap-2">
          <input id="vehicleNameInput" type="text" placeholder="e.g., Unit 001" class="w-full border rounded px-2 py-2" />
          <button id="addVehicleBtn" class="px-3 py-2 bg-emerald-600 text-white rounded">Add</button>
        </div>
        <p class="text-xs text-slate-600">Adding a vehicle requires uploading <strong>at least 4 base photos</strong> immediately in a popup. These are separate from inspection photos.</p>

        <details open>
          <summary class="font-semibold">Your Vehicles</summary>
          <ul id="vehicleList" class="mt-2 divide-y"></ul>
        </details>
      </div>
    </section>

    <!-- Organizations Tab -->
    <section id="tabOrganizations" class="tab hidden">
      <div class="bg-white rounded-xl shadow p-4 space-y-3">
        <h2 class="font-semibold text-lg">Organizations</h2>
        <details open>
          <summary class="font-medium">Add / Manage</summary>
          <div class="mt-2 flex gap-2">
            <input id="orgInput" type="text" placeholder="Add organization" class="w-full border rounded px-2 py-2" />
            <button id="addOrgBtn" class="px-3 py-2 bg-blue-600 text-white rounded">Add</button>
          </div>
          <ul id="orgList" class="mt-2 divide-y"></ul>
        </details>
      </div>
    </section>

    <!-- Personnel Tab -->
    <section id="tabPersonnel" class="tab hidden">
      <div class="bg-white rounded-xl shadow p-4 space-y-3">
        <h2 class="font-semibold text-lg">Personnel & Roles</h2>
        <details open>
          <summary class="font-medium">Add / Manage</summary>
          <div class="mt-2 grid grid-cols-1 sm:grid-cols-3 gap-2">
            <input id="personInput" type="text" placeholder="Add name" class="border rounded px-2 py-2" />
            <select id="personRoleInput" class="border rounded px-2 py-2">
              <option value="user">User</option>
              <option value="admin">Admin</option>
            </select>
            <button id="addPersonBtn" class="px-3 py-2 bg-teal-600 text-white rounded">Add</button>
          </div>
          <ul id="personList" class="mt-3 divide-y"></ul>
        </details>
      </div>
    </section>

    <!-- Inspections Tab (form + admin checklist editor) -->
    <section id="tabInspections" class="tab hidden">
      <div class="bg-white rounded-xl shadow p-4 space-y-4">
        <h2 class="font-semibold text-lg">New Inspection</h2>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
          <select id="inspYear" class="border rounded px-2 py-2"></select>
          <select id="inspVehicle" class="border rounded px-2 py-2"></select>
          <select id="inspType" class="border rounded px-2 py-2">
            <option value="Pre-check">Pre-check</option>
            <option value="In-check">In-check</option>
          </select>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
          <input id="inspDate" type="date" class="border rounded px-2 py-2" />
          <input id="inspTime" type="time" class="border rounded px-2 py-2" />
          <input id="mileage" type="number" placeholder="Mileage" class="border rounded px-2 py-2" />
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
          <input id="fuel" type="number" placeholder="Fuel %" class="border rounded px-2 py-2" />
          <select id="inspPerson" class="border rounded px-2 py-2"></select>
          <select id="inspOrg" class="border rounded px-2 py-2"></select>
        </div>

        <details open class="border rounded p-3">
          <summary class="font-medium">Checklist (all required)</summary>
          <div id="checklistContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-2"></div>
        </details>

        <div class="border rounded p-3">
          <div class="flex items-center justify-between mb-2">
            <span class="font-medium">Inspection Photos (min 4 required)</span>
            <label class="px-3 py-2 bg-slate-200 cursor-pointer rounded">Upload
              <input id="inspPhotoInput" type="file" accept="image/*" multiple class="hidden" />
            </label>
          </div>
          <div id="inspPhotoGrid" class="flex flex-wrap gap-2"></div>
        </div>

        <button id="saveInspectionBtn" class="px-3 py-2 bg-indigo-600 text-white rounded w-full">Save Inspection</button>
      </div>

      <!-- Admin Checklist Editor -->
      <div class="bg-white rounded-xl shadow p-4 space-y-3 mt-4">
        <div class="flex items-center gap-2">
          <h3 class="font-semibold text-lg">Checklist Library</h3>
          <span id="adminOnlyBadge" class="text-xs text-rose-700 hidden">(Admin only)</span>
        </div>
        <p class="text-xs text-slate-600">Admins can add/remove checklist items; the inspection form reflects this list.</p>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
          <input id="checkItemInput" type="text" placeholder="New checklist item" class="border rounded px-2 py-2" />
          <button id="addCheckItemBtn" class="px-3 py-2 bg-emerald-600 text-white rounded">Add Item</button>
          <button id="resetCheckItemsBtn" class="px-3 py-2 bg-rose-600 text-white rounded">Reset to Defaults</button>
        </div>
        <ul id="checklistLibraryList" class="mt-2 divide-y"></ul>
      </div>
    </section>

    <!-- Browser Tab -->
    <section id="tabBrowser" class="tab hidden">
      <div class="bg-white rounded-xl shadow p-4 space-y-3">
        <h2 class="font-semibold text-lg">Inspections Browser</h2>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
          <select id="filterYear" class="border rounded px-2 py-2"></select>
          <select id="filterVehicle" class="border rounded px-2 py-2"></select>
          <input id="filterText" class="border rounded px-2 py-2" placeholder="Search person/org/type" />
        </div>
        <div id="inspectionBrowserList" class="max-h-[70vh] overflow-y-auto space-y-2"></div>
      </div>
    </section>
  </div>

  <!-- Base Photos Modal -->
  <div id="basePhotosModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl max-w-md w-full max-h-[90vh] overflow-y-auto p-4">
      <h3 class="font-semibold text-lg mb-2">Add Base Photos (min 4)</h3>
      <input id="basePhotosInput" type="file" accept="image/*" multiple class="border rounded p-2 w-full" />
      <div id="basePhotosPreview" class="flex flex-wrap gap-2 my-3"></div>
      <div class="flex gap-2">
        <button id="cancelBasePhotosBtn" class="flex-1 px-3 py-2 rounded bg-slate-200">Cancel</button>
        <button id="confirmBasePhotosBtn" class="flex-1 px-3 py-2 rounded bg-emerald-600 text-white">Save Vehicle</button>
      </div>
    </div>
  </div>

  <!-- Day Viewer Modal -->
  <div id="dayViewerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-4">
      <div class="flex justify-between items-center mb-3">
        <h3 id="dayViewerTitle" class="text-lg font-semibold">Inspections</h3>
        <button id="closeDayViewerBtn" class="text-red-600">✕</button>
      </div>
      <div id="dayViewerContent" class="space-y-3"></div>
    </div>
  </div>

  <script>
    // ---------------------------------------------------------
    // PWA bootstrap: inject manifest + register service worker
    // ---------------------------------------------------------
    (function initPWA(){
      try {
        // 1) Create a blob URL from the inline manifest JSON and attach a <link rel="manifest">
        const json = document.getElementById('inline-manifest-json').textContent.trim();

        // Replace the short placeholders with full data URLs (embedded rhino icons).
        // (We intentionally keep only the beginning here to keep this file readable.)
        // Full base64 strings are injected below:
        const rhino192 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAE6UlEQVR4nO...";
        const rhino512 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAYAAAD0eNT6AAANnUlEQVR4nO...";

        const manifest = JSON.parse(json);
        manifest.icons[0].src = rhino192;
        manifest.icons[1].src = rhino512;

        const blob = new Blob([JSON.stringify(manifest)], {type: 'application/manifest+json'});
        const url = URL.createObjectURL(blob);
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = url;
        document.head.appendChild(link);

        // 2) Inline service worker
        if ('serviceWorker' in navigator) {
          const swCode = `
            const CACHE_NAME = 'vim-cache-v1';
            self.addEventListener('install', event => {
              event.waitUntil((async () => {
                const cache = await caches.open(CACHE_NAME);
                // Precache the root document and manifest
                await cache.addAll(['./']);
              })());
              self.skipWaiting();
            });

            self.addEventListener('activate', event => {
              event.waitUntil((async () => {
                const keys = await caches.keys();
                await Promise.all(keys.map(k => k === CACHE_NAME ? null : caches.delete(k)));
              })());
              self.clients.claim();
            });

            // Cache-first for same-origin; network fallback for others
            self.addEventListener('fetch', event => {
              const req = event.request;
              event.respondWith((async () => {
                try {
                  const cached = await caches.match(req);
                  if (cached) return cached;
                  const res = await fetch(req);
                  try {
                    const cache = await caches.open(CACHE_NAME);
                    cache.put(req, res.clone());
                  } catch (e) {}
                  return res;
                } catch (e) {
                  return caches.match('./'); // fallback to app shell
                }
              })());
            });
          `.trim();

          const swBlob = new Blob([swCode], {type:'text/javascript'});
          const swUrl = URL.createObjectURL(swBlob);
          navigator.serviceWorker.register(swUrl).catch(console.error);
        }
      } catch (e) {
        console.error('PWA bootstrap error', e);
      }
    })();
  </script>

  <script>
    // ===== Constants =====
    const YEARS = Array.from({ length: 2045 - 2025 + 1 }, (_, i) => 2025 + i);
    const DEFAULT_CHECKS = [
      "Horn operational", "AF Form 1800 signed", "Dash/cup holders/ashtray clean", "Floors vacuumed",
      "Trunk clean/empty", "Credit card present", "Fluid levels", "Lights operational", "Waiver form present",
      "Check for trash", "Body and rims clean", "Windshield wipers", "Windows clean", "Defrost/heat operational",
      "Air conditioning operational", "Spare tire/jack/lug wrench", "SF91 present", "SF94 present", "DD518 present",
      "Triangle kit present", "Fire extinguisher present"
    ];

    // ===== State =====
    let state = JSON.parse(localStorage.getItem('inspectionState')||'{}');
    if(!state.years) state.years = [...YEARS];
    if(!state.vehicles) state.vehicles = []; // {id,name,basePhotos:[], inspections:{ [year]:{[mm]:{[dd]:[records]}}}}
    if(!state.orgs) state.orgs = [];
    if(!state.personnel) state.personnel = []; // [{name,role:'admin'|'user'}]
    if(!state.checklistLibrary) state.checklistLibrary = [...DEFAULT_CHECKS];

    // Ensure at least one admin exists
    function ensureAdmin(){
      const hasAdmin = state.personnel.some(p=>p.role==='admin');
      if(!hasAdmin){ state.personnel.push({name:'Admin', role:'admin'}); saveState(); }
    }

    function saveState(){ localStorage.setItem('inspectionState', JSON.stringify(state)); }

    // ===== Migration =====
    function migrateState(){
      // vehicles.photos -> basePhotos; inspections flat -> nested
      (state.vehicles||[]).forEach(v=>{
        if(Array.isArray(v.photos) && !Array.isArray(v.basePhotos)){ v.basePhotos = v.photos; delete v.photos; }
        if(!Array.isArray(v.basePhotos)) v.basePhotos = [];
        if(!v.inspections || typeof v.inspections !== 'object') v.inspections = {};
        Object.keys(v.inspections).forEach(yr=>{
          const bucket = v.inspections[yr];
          if(Array.isArray(bucket)){
            const nested={};
            bucket.forEach(r=>{
              if(!r||!r.date) return; const [y,m,d]=r.date.split('-');
              nested[m] = nested[m]||{}; nested[m][d] = nested[m][d]||[]; nested[m][d].push(r);
            });
            v.inspections[yr]=nested;
          }
        });
      });
      // personnel as strings -> objects
      state.personnel = (state.personnel||[]).map(p=> typeof p==='string' ? {name:p, role:'user'} : p);
      // orgs unique
      state.orgs=[...new Set(state.orgs||[])];
      // checklist unique
      state.checklistLibrary=[...new Set((state.checklistLibrary||[]).filter(Boolean))];
      saveState();
    }
    migrateState();
    ensureAdmin();

    // ===== Utilities =====
    const $ = sel => document.querySelector(sel);
    function uid(){ return Math.random().toString(36).slice(2); }
    function mm(n){ return String(n).padStart(2,'0'); }
    function fileToDataURL(file){ return new Promise((res, rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

    // ===== Tabs =====
    document.querySelectorAll('.tabbtn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        // Clear active styles safely
        document.querySelectorAll('.tabbtn').forEach(b=>{
          b.classList.remove('bg-indigo-600','text-white');
          b.classList.add('bg-white','shadow');
        });
        // Activate clicked
        btn.classList.remove('bg-white','shadow');
        btn.classList.add('bg-indigo-600','text-white');
        // Show selected tab
        const id = btn.dataset.tab; document.querySelectorAll('.tab').forEach(t=>t.classList.add('hidden'));
        $('#'+id).classList.remove('hidden');
      });
    });

    // ===== Header: current user & role badge =====
    function renderCurrentUserUI(){
      const sel = $('#currentUser'); sel.innerHTML = (state.personnel||[]).map((p,i)=>`<option value="${i}">${p.name}</option>`).join('');
      if(state.personnel.length){ sel.value = '0'; }
      updateRoleBadge();
      sel.onchange = updateRoleBadge;
    }
    function currentUser(){ const idx = parseInt($('#currentUser').value||'0',10); return state.personnel[idx]||state.personnel[0]; }
    function isAdmin(){ return currentUser()?.role === 'admin'; }
    function updateRoleBadge(){
      const badge=$('#roleBadge'); const u=currentUser(); if(!u){ badge.textContent='Role: -'; return; }
      badge.textContent = `Role: ${u.role}`;
      document.getElementById('adminOnlyBadge').classList.toggle('hidden', !isAdmin());
      renderChecklistLibrary();
    }

    // ===== Calendar =====
    function renderYearsAccordion(){
      const host = $('#yearsAccordion'); host.innerHTML='';
      state.years.sort((a,b)=>a-b).forEach(y=>{
        const det=document.createElement('details'); det.className='border rounded-xl'; det.open=false; // collapsed by default
        const sum=document.createElement('summary'); sum.className='px-3 py-2 font-medium'; sum.textContent=y; det.appendChild(sum);
        const wrap=document.createElement('div'); wrap.className='p-3'; wrap.appendChild(renderCalendar(y)); det.appendChild(wrap);
        host.appendChild(det);
      });
    }
    function renderCalendar(year){ const box=document.createElement('div'); for(let m=0;m<12;m++) box.appendChild(renderMonth(year,m)); return box; }
    function renderMonth(year,month){
      const date=new Date(year,month,1); const monthName=date.toLocaleString('default',{month:'long'});
      const cont=document.createElement('div'); cont.className='mb-6'; cont.innerHTML=`<h4 class="font-medium mb-1">${monthName}</h4>`;
      const header=document.createElement('div'); header.className='grid grid-cols-7 text-center text-xs font-semibold';
      ;['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{ const c=document.createElement('div'); c.textContent=d; header.appendChild(c); });
      const grid=document.createElement('div'); grid.className='flex flex-wrap';
      const firstDay=date.getDay(); const daysInMonth=new Date(year,month+1,0).getDate();
      for(let i=0;i<firstDay;i++){ const pad=document.createElement('div'); pad.className='calendar-day'; grid.appendChild(pad); }
      for(let d=1; d<=daysInMonth; d++){
        const dayDiv=document.createElement('div'); dayDiv.className='calendar-day cursor-pointer hover:bg-slate-100';
        const label=document.createElement('div'); label.textContent=d; label.className='font-semibold'; dayDiv.appendChild(label);
        const count = countInspectionsForDate(year, month+1, d);
        if(count>0){
          const chip=document.createElement('div'); chip.className='count'; chip.textContent=count; dayDiv.appendChild(chip);
          dayDiv.onclick=()=>openDayViewer(year, month+1, d);
        }
        grid.appendChild(dayDiv);
      }
      cont.appendChild(header); cont.appendChild(grid); return cont;
    }
    function countInspectionsForDate(year,month,day){
      const m=mm(month), d=mm(day); let total=0;
      state.vehicles.forEach(v=>{ const arr=v.inspections?.[year]?.[m]?.[d]; if(Array.isArray(arr)) total+=arr.length; });
      return total;
    }
    // Expand/Collapse all
    document.getElementById('toggleYearsBtn').addEventListener('click',()=>{
      const btn=$('#toggleYearsBtn'); const all=[...document.querySelectorAll('#yearsAccordion details')];
      const anyOpen=all.some(d=>d.open); all.forEach(d=>d.open=!anyOpen);
      btn.textContent = anyOpen? 'Expand All Years' : 'Collapse All Years';
    });

    // ===== Vehicles =====
    let pendingVehicleName = null; let basePhotosDraft = [];
    function renderVehicles(){
      const ul=$('#vehicleList'); ul.innerHTML='';
      state.vehicles.forEach(v=>{
        const li=document.createElement('li'); li.className='py-2';
        const head=document.createElement('div'); head.className='flex items-center justify-between gap-2';
        head.innerHTML=`<span class='font-medium'>${v.name}</span>`;
        const actions=document.createElement('div'); actions.className='flex gap-2';
        const openBtn=document.createElement('button'); openBtn.className='px-2 py-1 text-xs rounded bg-slate-200'; openBtn.textContent='Open';
        const delBtn=document.createElement('button'); delBtn.className='px-2 py-1 text-xs rounded bg-rose-600 text-white'; delBtn.textContent='Delete';
        actions.appendChild(openBtn); actions.appendChild(delBtn); head.appendChild(actions); li.appendChild(head);

        const body=document.createElement('div'); body.className='mt-2 hidden';
        const gallery=document.createElement('div'); gallery.className='flex flex-wrap gap-2';
        (v.basePhotos||[]).forEach((src,idx)=>{
          const wrap=document.createElement('div'); wrap.className='relative';
          const img=document.createElement('img'); img.src=src; img.className='thumb'; wrap.appendChild(img);
          if(isAdmin()){
            const x=document.createElement('button'); x.className='absolute -top-2 -right-2 w-6 h-6 rounded-full bg-rose-600 text-white'; x.textContent='×';
            x.onclick=()=>{ v.basePhotos.splice(idx,1); saveState(); renderVehicles(); };
            wrap.appendChild(x);
          }
          gallery.appendChild(wrap);
        });
        body.appendChild(gallery);
        if(isAdmin()){
          const addWrap=document.createElement('div'); addWrap.className='mt-2';
          const addBtn=document.createElement('label'); addBtn.className='px-3 py-2 bg-slate-200 rounded inline-block cursor-pointer'; addBtn.textContent='Add Photos';
          const file=document.createElement('input'); file.type='file'; file.accept='image/*'; file.multiple=true; file.className='hidden';
          addBtn.appendChild(file); addWrap.appendChild(addBtn); body.appendChild(addWrap);
          file.onchange=async (e)=>{ const files=[...e.target.files]; for(const f of files){ v.basePhotos.push(await fileToDataURL(f)); } saveState(); renderVehicles(); };
        }

        openBtn.onclick=()=>{ body.classList.toggle('hidden'); };
        delBtn.onclick=()=>{ if(!confirm('Delete vehicle and all inspections?')) return; state.vehicles=state.vehicles.filter(x=>x.id!==v.id); saveState(); renderEverything(); };
        li.appendChild(body); ul.appendChild(li);
      });
    }
    document.getElementById('addVehicleBtn').addEventListener('click',()=>{
      const name=$('#vehicleNameInput').value.trim(); if(!name){ alert('Enter a vehicle name'); return; }
      pendingVehicleName = name; basePhotosDraft=[]; $('#basePhotosPreview').innerHTML=''; $('#basePhotosInput').value=''; openBasePhotosModal();
    });
    function openBasePhotosModal(){ const m=$('#basePhotosModal'); m.classList.remove('hidden'); m.classList.add('flex'); }
    function closeBasePhotosModal(){ const m=$('#basePhotosModal'); m.classList.add('hidden'); m.classList.remove('flex'); }
    $('#cancelBasePhotosBtn').addEventListener('click',()=>{ pendingVehicleName=null; basePhotosDraft=[]; closeBasePhotosModal(); });
    $('#basePhotosInput').addEventListener('change', async (e)=>{
      const files=[...e.target.files]; for(const f of files){ basePhotosDraft.push(await fileToDataURL(f)); } renderBasePhotosDraft(); e.target.value='';
    });
    function renderBasePhotosDraft(){
      const grid=$('#basePhotosPreview'); grid.innerHTML='';
      basePhotosDraft.forEach((src,idx)=>{
        const wrap=document.createElement('div'); wrap.className='relative';
        const img=document.createElement('img'); img.src=src; img.className='thumb';
        const x=document.createElement('button'); x.className='absolute -top-2 -right-2 w-6 h-6 rounded-full bg-rose-600 text-white'; x.textContent='×';
        x.onclick=()=>{ basePhotosDraft.splice(idx,1); renderBasePhotosDraft(); };
        wrap.appendChild(img); wrap.appendChild(x); grid.appendChild(wrap);
      });
    }
    $('#confirmBasePhotosBtn').addEventListener('click',()=>{
      if(basePhotosDraft.length<4){ alert('Please add at least 4 photos'); return; }
      const v={ id:uid(), name:pendingVehicleName, basePhotos:[...basePhotosDraft], inspections:{} };
      state.vehicles.push(v); saveState(); pendingVehicleName=null; basePhotosDraft=[]; closeBasePhotosModal(); $('#vehicleNameInput').value=''; renderVehicles(); renderSelects(); alert('Vehicle created');
    });

    // ===== Organizations =====
    function renderOrgs(){
      const ul=$('#orgList'); ul.innerHTML='';
      (state.orgs||[]).forEach((o,i)=>{
        const li=document.createElement('li'); li.className='py-2 flex items-center justify-between';
        li.innerHTML=`<span>${o}</span>`;
        const del=document.createElement('button'); del.className='px-2 py-1 text-xs rounded bg-rose-600 text-white'; del.textContent='Delete';
        del.onclick=()=>{ state.orgs.splice(i,1); saveState(); renderOrgs(); renderSelects(); };
        li.appendChild(del); ul.appendChild(li);
      });
    }
    $('#addOrgBtn').addEventListener('click',()=>{
      const name=$('#orgInput').value.trim(); if(!name) return alert('Enter an organization');
      if(state.orgs.includes(name)) return alert('Already exists');
      state.orgs.push(name); saveState(); $('#orgInput').value=''; renderOrgs(); renderSelects();
    });

    // ===== Personnel & Roles =====
    function renderPeople(){
      const ul=$('#personList'); ul.innerHTML='';
      (state.personnel||[]).forEach((p,i)=>{
        const li=document.createElement('li'); li.className='py-2 flex items-center gap-2 justify-between';
        const left=document.createElement('div'); left.className='flex items-center gap-2';
        left.innerHTML=`<span class='font-medium'>${p.name}</span>`;
        const roleSel=document.createElement('select'); roleSel.className='border rounded px-2 py-1 text-sm';
        roleSel.innerHTML=`<option value='user'>User</option><option value='admin'>Admin</option>`;
        roleSel.value=p.role; roleSel.onchange=()=>{ p.role=roleSel.value; saveState(); updateRoleBadge(); renderPeople(); };
        left.appendChild(roleSel); li.appendChild(left);
        const right=document.createElement('div');
        const del=document.createElement('button'); del.className='px-2 py-1 text-xs rounded bg-rose-600 text-white'; del.textContent='Delete';
        del.onclick=()=>{ state.personnel.splice(i,1); saveState(); renderPeople(); renderCurrentUserUI(); };
        right.appendChild(del); li.appendChild(right); ul.appendChild(li);
      });
    }
    $('#addPersonBtn').addEventListener('click',()=>{
      const name=$('#personInput').value.trim(); const role=$('#personRoleInput').value;
      if(!name) return alert('Enter a name'); if(state.personnel.some(p=>p.name===name)) return alert('Already exists');
      state.personnel.push({name, role}); saveState(); $('#personInput').value=''; renderPeople(); renderCurrentUserUI(); renderSelects();
    });

    // ===== Checklist Library (Admin) =====
    function renderChecklistLibrary(){
      const ul=$('#checklistLibraryList'); ul.innerHTML='';
      (state.checklistLibrary||[]).forEach((item,idx)=>{
        const li=document.createElement('li'); li.className='py-2 flex items-center justify-between';
        li.innerHTML=`<span>${item}</span>`;
        const del=document.createElement('button'); del.className='px-2 py-1 text-xs rounded bg-rose-600 text-white'; del.textContent='Remove';
        del.disabled=!isAdmin();
        del.onclick=()=>{ state.checklistLibrary.splice(idx,1); saveState(); renderChecklistLibrary(); renderChecklistForm(); };
        li.appendChild(del); ul.appendChild(li);
      });
      $('#addCheckItemBtn').disabled=!isAdmin(); $('#resetCheckItemsBtn').disabled=!isAdmin();
    }
    $('#addCheckItemBtn').addEventListener('click',()=>{
      if(!isAdmin()) return alert('Admin only');
      const txt=$('#checkItemInput').value.trim(); if(!txt) return; if(state.checklistLibrary.includes(txt)) return alert('Item exists');
      state.checklistLibrary.push(txt); saveState(); $('#checkItemInput').value=''; renderChecklistLibrary(); renderChecklistForm();
    });
    $('#resetCheckItemsBtn').addEventListener('click',()=>{
      if(!isAdmin()) return alert('Admin only');
      if(!confirm('Reset checklist to defaults?')) return;
      state.checklistLibrary=[...DEFAULT_CHECKS]; saveState(); renderChecklistLibrary(); renderChecklistForm();
    });

    // ===== Inspection Form =====
    let inspDraftPhotos = [];
    function renderSelects(){
      // years
      $('#inspYear').innerHTML = state.years.map(y=>`<option value='${y}'>${y}</option>`).join('');
      // vehicles
      $('#inspVehicle').innerHTML = state.vehicles.map(v=>`<option value='${v.id}'>${v.name}</option>`).join('');
      // people
      $('#inspPerson').innerHTML = state.personnel.map(p=>`<option>${p.name}</option>`).join('');
      // orgs
      $('#inspOrg').innerHTML = state.orgs.map(o=>`<option>${o}</option>`).join('');
      // filters
      $('#filterYear').innerHTML = ['All',...state.years].map(y=>`<option value='${y}'>${y}</option>`).join('');
      $('#filterVehicle').innerHTML = [{id:'All',name:'All vehicles'},...state.vehicles].map(v=>`<option value='${v.id||v}'>${v.name||v}</option>`).join('');
    }
    function renderChecklistForm(){
      const host=$('#checklistContainer'); host.innerHTML='';
      (state.checklistLibrary||[]).forEach(label=>{
        const id='chk_'+label.replace(/[^a-z0-9]+/gi,'_');
        const wrap=document.createElement('label'); wrap.className='flex items-center gap-2';
        const cb=document.createElement('input'); cb.type='checkbox'; cb.id=id; cb.required=true;
        wrap.appendChild(cb); wrap.appendChild(document.createTextNode(label)); host.appendChild(wrap);
      });
    }
    $('#inspPhotoInput').addEventListener('change', async (e)=>{
      const files=[...e.target.files]; for(const f of files){ inspDraftPhotos.push(await fileToDataURL(f)); }
      renderInspDraftPhotos(); e.target.value='';
    });
    function renderInspDraftPhotos(){
      const grid=$('#inspPhotoGrid'); grid.innerHTML='';
      inspDraftPhotos.forEach((src,idx)=>{
        const wrap=document.createElement('div'); wrap.className='relative';
        const img=document.createElement('img'); img.src=src; img.className='thumb';
        const x=document.createElement('button'); x.className='absolute -top-2 -right-2 w-6 h-6 rounded-full bg-rose-600 text-white'; x.textContent='×';
        x.onclick=()=>{ inspDraftPhotos.splice(idx,1); renderInspDraftPhotos(); };
        wrap.appendChild(img); wrap.appendChild(x); grid.appendChild(wrap);
      });
    }
    $('#saveInspectionBtn').addEventListener('click',()=>{
      const vehicleId = $('#inspVehicle').value; const vehicle = state.vehicles.find(v=>v.id===vehicleId);
      if(!vehicle) return alert('Select a vehicle');
      const year = parseInt($('#inspYear').value,10);
      const dateVal = $('#inspDate').value; if(!dateVal) return alert('Select a date');
      const timeVal = $('#inspTime').value || '00:00';
      const typeVal = $('#inspType').value;
      const person = $('#inspPerson').value; const org = $('#inspOrg').value;
      const mileage = parseInt($('#mileage').value||''); const fuel = parseInt($('#fuel').value||'');

      // Validate checklist
      const checks={}; let allChecked=true;
      (state.checklistLibrary||[]).forEach(label=>{
        const id='chk_'+label.replace(/[^a-z0-9]+/gi,'_');
        const c=document.getElementById(id);
        checks[label]=!!c?.checked; if(!c?.checked) allChecked=false;
      });
      if(!allChecked) return alert('All checklist items must be completed');
      if(inspDraftPhotos.length<4) return alert('Please upload at least 4 inspection photos');

      const [yyyy, mm, dd] = dateVal.split('-');
      if(!vehicle.inspections[yyyy]) vehicle.inspections[yyyy] = {};
      if(!vehicle.inspections[yyyy][mm]) vehicle.inspections[yyyy][mm] = {};
      if(!vehicle.inspections[yyyy][mm][dd]) vehicle.inspections[yyyy][mm][dd] = [];

      const rec = {
        id:uid(), date:dateVal, time:timeVal, type:typeVal, person, org,
        mileage:isNaN(mileage)?null:mileage, fuel:isNaN(fuel)?null:fuel,
        checks, photos:[...inspDraftPhotos]
      };
      vehicle.inspections[yyyy][mm][dd].push(rec);
      saveState();
      inspDraftPhotos=[]; renderInspDraftPhotos();
      renderYearsAccordion(); renderInspectionBrowser();
      alert('Inspection saved');
    });

    // ===== Browser =====
    function renderInspectionBrowser(){
      const fy=$('#filterYear').value; const fv=$('#filterVehicle').value; const q=($('#filterText').value||'').toLowerCase();
      const list=$('#inspectionBrowserList'); list.innerHTML='';
      let items=[];
      state.vehicles.forEach(v=>{
        if(fv && fv!=='All' && fv!==v.id) return;
        Object.entries(v.inspections||{}).forEach(([yr,months])=>{
          if(fy && fy!=='All' && String(yr)!==String(fy)) return;
          Object.entries(months||{}).forEach(([m,days])=>{
            Object.entries(days||{}).forEach(([d,arr])=>{
              arr.forEach(r=> items.push({...r, vehicle:v.name, year:+yr}));
            });
          });
        });
      });
      items.sort((a,b)=> (a.date+a.time).localeCompare(b.date+b.time));
      if(q){ items = items.filter(r=> `${r.person} ${r.org} ${r.type} ${r.vehicle}`.toLowerCase().includes(q)); }
      if(!items.length){ list.innerHTML='<div class="text-sm text-slate-500">No inspections match.</div>'; return; }
      items.forEach(r=>{
        const row=document.createElement('div'); row.className='border rounded p-2 text-sm flex justify-between items-center';
        row.innerHTML = `<div>${r.date} ${r.time} — ${r.type} — ${r.person} (${r.org}) — ${r.vehicle} — ${r.mileage??'-'} mi — ${r.fuel??'-'}%</div>`;
        const btn=document.createElement('button'); btn.className='px-2 py-1 text-xs rounded bg-slate-200'; btn.textContent='View';
        btn.onclick=()=>{ const [y,m,d]=r.date.split('-'); openDayViewer(+y,+m,+d); };
        row.appendChild(btn); list.appendChild(row);
      });
    }
    ['filterYear','filterVehicle','filterText'].forEach(id=> document.getElementById(id).addEventListener('input', renderInspectionBrowser));

    function openDayViewer(year,month,day){
      const m=mm(month), d=mm(day); const list=[];
      state.vehicles.forEach(v=>{ const arr=v.inspections?.[year]?.[m]?.[d]; if(Array.isArray(arr)) arr.forEach(r=> list.push({vehicle:v.name, ...r})); });
      list.sort((a,b)=> (a.time||'').localeCompare(b.time||''));
      $('#dayViewerTitle').textContent=`${year}-${m}-${d} — ${list.length} inspection${list.length!==1?'s':''}`;
      const host=$('#dayViewerContent'); host.innerHTML='';
      list.forEach(r=>{
        const card=document.createElement('div'); card.className='border rounded p-3 space-y-2';
        const checksHTML = Object.keys(r.checks||{}).map(k=> `<label class='flex items-center gap-2 text-sm'><input type='checkbox' disabled ${r.checks[k]?'checked':''}/> ${k}</label>`).join('');
        const photosHTML = (r.photos||[]).map(src=> `<img class='thumb' src='${src}'/>`).join('');
        card.innerHTML = `
          <div class='font-semibold'>${r.date} ${r.time} — ${r.type}</div>
          <div class='text-sm'>Inspector: ${r.person||'-'} (${r.org||'-'})</div>
          <div class='text-sm'>Vehicle: ${r.vehicle}</div>
          <div class='text-sm'>Mileage: ${r.mileage??'-'} mi, Fuel: ${r.fuel??'-'}%</div>
          <div class='grid grid-cols-1 sm:grid-cols-2 gap-1'>${checksHTML}</div>
          <div class='flex flex-wrap gap-2'>${photosHTML}</div>
        `;
        host.appendChild(card);
      });
      const modal=$('#dayViewerModal'); modal.classList.remove('hidden'); modal.classList.add('flex');
    }
    $('#closeDayViewerBtn').addEventListener('click',()=>{ const modal=$('#dayViewerModal'); modal.classList.add('hidden'); modal.classList.remove('flex'); });

    // ===== Backup/Restore =====
    document.getElementById('exportBtn').addEventListener('click',()=>{
      const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='vehicle_inspection_backup.json'; a.click();
      URL.revokeObjectURL(url);
    });
    document.getElementById('importInput').addEventListener('change', async (e)=>{
      const f=e.target.files?.[0]; if(!f) return;
      try{
        const text=await f.text(); const data=JSON.parse(text);
        state=data; migrateState(); ensureAdmin(); saveState(); renderEverything(); alert('Restore complete');
      }catch{ alert('Invalid backup file'); }
      e.target.value='';
    });

    // ===== Render All =====
    function renderEverything(){
      renderYearsAccordion(); renderVehicles(); renderOrgs(); renderPeople();
      renderSelects(); renderChecklistForm(); renderChecklistLibrary(); renderCurrentUserUI(); renderInspectionBrowser();
    }

    // ===== Minimal sanity tests (added) =====
    function runSanityTests(){
      try { document.querySelectorAll('.tabbtn').forEach(b=>b.click()); console.log('Tab toggle smoke test passed'); } catch(e){ console.error('Tab toggle test failed', e); }
      try {
        const st = { vehicles:[ { inspections: { '2025': [ {date:'2025-03-14', time:'08:00'} ] } } ] };
        (function migrateLocal(s){
          s.vehicles.forEach(v=>{
            if(Array.isArray(v.inspections['2025'])){
              const nested={};
              v.inspections['2025'].forEach(r=>{
                const [y,m,d]=r.date.split('-');
                nested[m]=nested[m]||{}; nested[m][d]=nested[m][d]||[]; nested[m][d].push(r);
              });
              v.inspections['2025']=nested;
            }
          });
        })(st);
        console.assert(Array.isArray(st.vehicles[0].inspections['2025']['03']['14']), 'Migration nested array expected');
        console.log('Migration test passed');
      } catch(e){ console.error('Migration test failed', e); }
    }

    // Bootstrap
    renderEverything();
    runSanityTests();
  </script>
</body>
</html>
