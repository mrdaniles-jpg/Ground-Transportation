<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>SJAFB Ground Transportation (PWA, Single-File)</title>
  <!-- No external CSS: minimal utility CSS to mimic Tailwind-ish classes for mobile -->
  <style>
    :root{--bg:#f8fafc;--card:#fff;--ink:#0f172a;--muted:#64748b;--brand:#4f46e5;--ok:#059669;--warn:#dc2626;--chip:#2563eb;--ring:#2563eb}
    *{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial; background:var(--bg); color:var(--ink)}
    .container{max-width:1100px;margin:0 auto;padding:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .card{background:var(--card);border-radius:14px;box-shadow:0 1px 3px rgba(0,0,0,.07);padding:12px}
    .btn{border:0;border-radius:12px;padding:10px 12px;font-weight:600;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-primary{background:var(--brand);color:#fff}
    .btn-ok{background:var(--ok);color:#fff}
    .btn-warn{background:var(--warn);color:#fff}
    .btn-ghost{background:#e2e8f0}
    .field{border:1px solid #e5e7eb;border-radius:10px;padding:10px;width:100%}
    .label{font-size:12px;color:var(--muted)}
    .hidden{display:none!important}
    .tabs{display:flex;gap:8px;overflow:auto}
    .tabbtn{padding:10px 12px;border-radius:12px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.05);white-space:nowrap}
    .tabbtn.active{background:var(--brand);color:#fff}
    .tab{display:none}
    .tab.active{display:block}
    .badge{display:inline-flex;align-items:center;gap:6px;background:#e2e8f0;padding:3px 8px;border-radius:999px;font-size:12px}
    .grid7{display:grid;grid-template-columns:repeat(7,1fr);gap:0}
    .calendar-day{width:100%;height:84px;border:1px solid #e5e7eb;display:flex;flex-direction:column;align-items:flex-start;justify-content:flex-start;padding:4px;font-size:12px;position:relative}
    .calendar-day .count{position:absolute;right:4px;bottom:4px;font-size:10px;background:var(--chip);color:#fff;border-radius:999px;padding:0 6px}
    .calendar-day.today{outline:2px solid var(--ring)}
    details>summary{cursor:pointer;padding:8px 10px;font-weight:600}
    .thumb{width:80px;height:80px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;z-index:60}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:14px;z-index:50}
    .modal.open{display:flex}
    .modal .sheet{background:#fff;border-radius:16px;max-width:900px;width:100%;max-height:90vh;overflow:auto;padding:14px}
    .kv{display:grid;grid-template-columns:150px 1fr;gap:6px;font-size:14px}
    .kv div:nth-child(odd){color:var(--muted)}
    .divider{height:1px;background:#e5e7eb;margin:8px 0}
    .list{display:flex;flex-direction:column}
    .list>div{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #e5e7eb}
    .pill{font-size:11px;background:#eef2ff;color:#3730a3;padding:2px 8px;border-radius:999px}
    .pill-red{background:#fee2e2;color:#991b1b}
    .note{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <header class="row" style="align-items:center;justify-content:space-between">
      <h1 style="font-size:18px;font-weight:800">Rental Vehicle Manager</h1>
      <div class="row">
        <span id="roleBadge" class="badge">Role: ‚Äì</span>
        <button id="backupBtn" class="btn btn-ghost">Backup</button>
        <label id="restoreLabel" class="btn btn-ghost">Restore<input id="restoreInput" type="file" accept="application/json" class="hidden"/></label>
      </div>
    </header>

    <!-- Tabs -->
    <nav class="tabs" id="tabs">
      <button class="tabbtn active" data-tab="calendarTab">Calendar</button>
      <button class="tabbtn" data-tab="vehiclesTab">Vehicles</button>
      <button class="tabbtn" data-tab="orgsTab">Organizations</button>
      <button class="tabbtn" data-tab="peopleTab">Personnel</button>
      <button class="tabbtn" data-tab="inspectTab">Inspections</button>
      <button class="tabbtn" data-tab="browserTab">Browser</button>
    </nav>

    <!-- Calendar Tab -->
    <section id="calendarTab" class="tab active card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">Years 2025‚Äì2045</h2>
        <button id="toggleYears" class="btn btn-primary">Expand All Years</button>
      </div>
      <p class="note">Tap a year to expand its calendar. Days with inspections show a count.</p>
      <div id="yearsHost" class="row" style="flex-direction:column;gap:10px"></div>
    </section>

    <!-- Vehicles Tab -->
    <section id="vehiclesTab" class="tab card">
      <h2>Add Vehicle</h2>
      <div class="row">
        <input id="vehName" class="field" placeholder="Vehicle name (e.g., Unit 001)"/>
        <input id="vehMileage" type="number" class="field" placeholder="Mileage" style="max-width:200px"/>
        <button id="vehAdd" class="btn btn-ok">Add</button>
      </div>
      <p class="note">Adding a vehicle requires uploading <b>at least 4 base photos</b> in a popup. (Separate from inspection photos)</p>
      <div class="divider"></div>
      <details open>
        <summary>Your Vehicles</summary>
        <div id="vehList" class="list"></div>
      </details>
    </section>

    <!-- Organizations Tab -->
    <section id="orgsTab" class="tab card">
      <h2>Organizations</h2>
      <div class="row">
        <input id="orgInput" class="field" placeholder="Add organization"/>
        <button id="orgAdd" class="btn btn-ok">Add</button>
      </div>
      <details open>
        <summary>Manage</summary>
        <div id="orgList" class="list"></div>
      </details>
    </section>

    <!-- Personnel Tab -->
    <section id="peopleTab" class="tab card">
      <h2>Personnel & Roles</h2>
      <div class="row">
        <input id="personInput" class="field" placeholder="Add person"/>
        <select id="personRole" class="field" style="max-width:200px"><option value="user">User</option><option value="admin">Admin</option></select>
        <button id="personAdd" class="btn btn-ok">Add</button>
      </div>
      <details open>
        <summary>Manage</summary>
        <div id="peopleList" class="list"></div>
      </details>
    </section>

    <!-- Inspections Tab -->
    <section id="inspectTab" class="tab card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2>New Inspection</h2>
        <span id="trashIndicator" class="badge">üóëÔ∏è Trash: <span id="trashCount">0</span></span>
      </div>
      <div class="row">
        <select id="inspYear" class="field" style="max-width:160px"></select>
        <select id="inspVehicle" class="field"></select>
        <select id="inspType" class="field" style="max-width:180px">
          <option>Pre-check</option>
          <option>In-check</option>
          <option>Customer-check</option>
        </select>
      </div>
      <div class="row">
        <input id="inspDate" type="date" class="field" style="max-width:200px"/>
        <input id="inspTime" type="time" class="field" style="max-width:160px"/>
        <input id="inspMileage" type="number" class="field" placeholder="Mileage" style="max-width:160px"/>
        <input id="inspFuel" type="number" class="field" placeholder="Fuel %" style="max-width:140px"/>
      </div>
      <div class="row">
        <select id="inspPerson" class="field"></select>
        <select id="inspOrg" class="field"></select>
      </div>
      <p class="note">If type is <b>Customer-check</b>, the Person list is disabled and Org is required.</p>

      <details open class="card" style="padding:10px;margin-top:8px">
        <summary>Checklist (all required; some allow Yes/No)</summary>
        <div id="checklistForm" class="row" style="display:grid;grid-template-columns:1fr 1fr;gap:8px"></div>
      </details>

      <div class="card" style="padding:10px;margin-top:8px">
        <div class="row" style="justify-content:space-between;align-items:center">
          <span class="label">Inspection Photos (min 4)</span>
          <label class="btn btn-ghost">Upload<input id="inspPhotos" type="file" accept="image/*" multiple class="hidden"></label>
        </div>
        <div id="inspPhotoGrid" class="row"></div>
      </div>

      <button id="saveInspection" class="btn btn-primary" style="width:100%">Save Inspection</button>

      <!-- Inspections Trash -->
      <details id="trashDetails" class="card" style="margin-top:10px">
        <summary>üóëÔ∏è Inspection Trash</summary>
        <div class="row" style="justify-content:flex-end;gap:8px;margin-bottom:6px">
          <button id="restoreSelected" class="btn btn-ok" disabled>Restore Selected</button>
          <button id="clearTrash" class="btn btn-warn" disabled>Clear All</button>
        </div>
        <div id="trashList" class="list"></div>
        <p class="note">Items auto-delete after 35 days.</p>
      </details>
    </section>

    <!-- Browser Tab -->
    <section id="browserTab" class="tab card">
      <h2>Inspections Browser</h2>
      <div class="row">
        <select id="filterYear" class="field" style="max-width:160px"></select>
        <select id="filterVehicle" class="field"></select>
        <input id="filterQuery" class="field" placeholder="Search person/org/type"/>
      </div>
      <div id="browserList" style="max-height:65vh;overflow:auto;margin-top:8px;display:flex;flex-direction:column;gap:8px"></div>
    </section>
  </div>

  <!-- Base Photos Modal -->
  <div id="vehModal" class="modal"><div class="sheet">
    <h3>Add Base Photos (min 4)</h3>
    <input id="vehPhotosInput" type="file" accept="image/*" multiple class="field"/>
    <div id="vehPhotosPreview" class="row" style="margin-top:8px"></div>
    <div class="row"><button id="vehCancel" class="btn btn-ghost" style="flex:1">Cancel</button><button id="vehConfirm" class="btn btn-ok" style="flex:1">Save Vehicle</button></div>
  </div></div>

  <!-- Day Viewer Modal -->
  <div id="dayModal" class="modal"><div class="sheet">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 id="dayTitle">Inspections</h3>
      <button id="dayClose" class="btn btn-warn">Close</button>
    </div>
    <div id="dayContent" style="display:flex;flex-direction:column;gap:10px;margin-top:8px"></div>
  </div></div>

  <!-- Edit Inspection Modal -->
  <div id="editModal" class="modal"><div class="sheet" style="max-width:520px">
    <h3>Edit Inspection</h3>
    <div class="row">
      <input id="editDate" type="date" class="field" style="max-width:200px"/>
      <input id="editTime" type="time" class="field" style="max-width:160px"/>
    </div>
    <div class="row">
      <select id="editType" class="field" style="max-width:180px">
        <option>Pre-check</option>
        <option>In-check</option>
        <option>Customer-check</option>
      </select>
      <select id="editPerson" class="field"></select>
      <select id="editOrg" class="field"></select>
    </div>
    <div class="row">
      <input id="editMileage" type="number" class="field" placeholder="Mileage" style="max-width:160px"/>
      <input id="editFuel" type="number" class="field" placeholder="Fuel %" style="max-width:140px"/>
    </div>
    <div class="row">
      <button id="editCancel" class="btn btn-ghost" style="flex:1">Cancel</button>
      <button id="editSave" class="btn btn-primary" style="flex:1">Save Changes</button>
    </div>
  </div></div>

  <!-- Lightbox Modal -->
  <div id="lightbox" class="modal"><div class="sheet" style="max-width:95vw"><img id="lightboxImg" src="" style="width:100%;height:auto;border-radius:12px"/></div></div>

  <!-- Login Modal -->
  <div id="loginModal" class="modal open"><div class="sheet" style="max-width:460px">
    <h3>Login</h3>
    <div class="row" style="flex-direction:column">
      <div class="row" style="gap:12px">
        <label class="badge"><input type="radio" name="loginMode" value="personnel" checked/> Personnel</label>
        <label class="badge"><input type="radio" name="loginMode" value="org"/> Organization</label>
      </div>
      <select id="loginSelector" class="field"></select>
      <input id="loginPassword" type="password" class="field" placeholder="Password"/>
      <button id="loginBtn" class="btn btn-primary">Sign in</button>
    </div>
  </div></div>

  <!-- Toast -->
  <div id="toast" class="toast hidden"></div>

  <!-- Manifest will be generated at runtime (single-file icons) -->
  <link id="manifestLink" rel="manifest" href="#"/>

  <script>
  /***********************
   * Simple IndexedDB API
   ***********************/
  const DB_NAME='rvm_db', STORE='rvm_store';
  const idb={
    _db:null,
    async open(){ if(this._db) return this._db; this._db=await new Promise((res,rej)=>{ const req=indexedDB.open(DB_NAME,1); req.onupgradeneeded=e=>{ e.target.result.createObjectStore(STORE); }; req.onsuccess=e=>res(e.target.result); req.onerror=e=>rej(e.target.error); }); return this._db; },
    async get(key){ const db=await this.open(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readonly'); const st=tx.objectStore(STORE); const req=st.get(key); req.onsuccess=()=>res(req.result); req.onerror=e=>rej(e.target.error); }); },
    async set(key,val){ const db=await this.open(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readwrite'); const st=tx.objectStore(STORE); const req=st.put(val,key); req.onsuccess=()=>res(true); req.onerror=e=>rej(e.target.error); }); }
  };

  /***********************
   * PWA: runtime manifest + SW
   ***********************/
  async function makeRhinoIcon(size){
    const c=document.createElement('canvas'); c.width=c.height=size; const ctx=c.getContext('2d');
    ctx.fillStyle='#f5f5f5'; ctx.fillRect(0,0,size,size);
    ctx.font=Math.floor(size*0.72)+"px";
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillStyle='#374151'; ctx.fillText('\uD83E\uDD8F', size/2, size/2);
    return await new Promise(r=> c.toBlob(b=> r(URL.createObjectURL(b)), 'image/png'));
  }
  async function registerManifest(){
    const icon192=await makeRhinoIcon(192); const icon512=await makeRhinoIcon(512);
    const manifest={
      name:'Rental Vehicle Manager', short_name:'RVM', start_url:'./', display:'standalone', background_color:'#ffffff', theme_color:'#4f46e5',
      icons:[ {src:icon192, sizes:'192x192', type:'image/png'}, {src:icon512, sizes:'512x512', type:'image/png'} ]
    };
    const blob=new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'}); const url=URL.createObjectURL(blob); document.getElementById('manifestLink').setAttribute('href',url);
  }
  async function registerSW(){
    if(!('serviceWorker' in navigator)) return; const swCode=`self.addEventListener('install',e=>{self.skipWaiting(); e.waitUntil(caches.open('rvm-cache-v1').then(c=>c.addAll(['./'])))});self.addEventListener('activate',e=>{self.clients.claim()});self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(resp=>{const copy=resp.clone(); caches.open('rvm-cache-v1').then(c=>c.put(e.request,copy)); return resp;})).catch(()=>caches.match('./')))});`;
    const blob=new Blob([swCode],{type:'text/javascript'}); const url=URL.createObjectURL(blob); try{ await navigator.serviceWorker.register(url); }catch(err){ console.warn('SW failed', err); }
  }
  registerManifest(); registerSW();

  /***********************
   * App State & Defaults
   ***********************/
  const YEARS=Array.from({length:2045-2025+1},(_,i)=>2025+i);
  const DEFAULT_CHECKS=[
    {label:'Horn operational', kind:'check'},
    {label:'AF Form 1800 signed', kind:'check'},
    {label:'Dash/Cup Holders/Ashtray Clean', kind:'check'},
    {label:'Floors Vacuumed', kind:'check'},
    {label:'Trunk Clean/Empty', kind:'check'},
    {label:'Credit Card Present', kind:'yn'},
    {label:'Fluid levels', kind:'check'},
    {label:'Lights Operational', kind:'check'},
    {label:'Waiver Form Present', kind:'check'},
    {label:'Check For Trash', kind:'check'},
    {label:'Body and Rims Clean', kind:'check'},
    {label:'Windshield Wipers', kind:'check'},
    {label:'Windows Clean', kind:'check'},
    {label:'Defrost/Heat Operational', kind:'check'},
    {label:'Air Conditioning Operational', kind:'check'},
    {label:'Spare Tire/Jack/Lug Wrench', kind:'check'},
    {label:'SF91 Present', kind:'check'},
    {label:'SF94 Present', kind:'check'},
    {label:'DD518 Present', kind:'check'},
    {label:'Triangle Kit', kind:'yn'},
    {label:'Fire Extinguisher', kind:'yn'}
  ];

  const PW={personnel:'1299', org:'ground transportation', danielsAdmin:'6325'};

  let state={ years:[...YEARS], vehicles:[], orgs:[], people:[], checks:[...DEFAULT_CHECKS], inspectionTrash:[] };
  let session={ user:null, role:'guest' }; // role: user|admin|org

  async function loadState(){ const saved=await idb.get('state'); if(saved){ state=saved; if(!state.inspectionTrash) state.inspectionTrash=[]; } else { await seed(); } await cleanupTrash(true); await persist(); }
  async function seed(){
    if(!state.people.length){ state.people=[ {name:'Daniels', role:'admin', passHash: await hash('6325')} ]; }
  }
  async function persist(){ await idb.set('state', state); updateRoleUI(); renderTrashIndicator(); }

  async function hash(str){
    if (crypto && crypto.subtle && crypto.subtle.digest) {
      const enc=new TextEncoder().encode(str); const buf=await crypto.subtle.digest('SHA-256',enc); const a=Array.from(new Uint8Array(buf)); return a.map(x=>x.toString(16).padStart(2,'0')).join('');
    } else {
      let h=0; for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0; } return 'h'+(h>>>0).toString(16);
    }
  }

  /***********************
   * Helpers & UI utilities
   ***********************/
  const $=sel=>document.querySelector(sel);
  function mm(n){return String(n).padStart(2,'0');}
  function toast(msg){ const el=$('#toast'); el.textContent=msg; el.classList.remove('hidden'); clearTimeout(toast._t); toast._t=setTimeout(()=>el.classList.add('hidden'),1800); }
  function openModal(id){ $(id).classList.add('open'); }
  function closeModal(id){ $(id).classList.remove('open'); }
  function uid(){ return Math.random().toString(36).slice(2); }
  function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

  /***********************
   * Tabs
   ***********************/
  document.querySelectorAll('#tabs .tabbtn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('#tabs .tabbtn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.getElementById(btn.dataset.tab).classList.add('active');
    });
  });

  /***********************
   * Renderers
   ***********************/
  function updateRoleUI(){
    $('#roleBadge').textContent = 'Role: ' + (session.role||'guest');
    const isAdmin=session.role==='admin';
    $('#backupBtn').disabled=!isAdmin;
    const rl=$('#restoreLabel');
    rl.style.pointerEvents = isAdmin? 'auto':'none';
    rl.style.opacity = isAdmin? '1':'.5';
    // trash admin buttons
    $('#restoreSelected').disabled=!isAdmin || !$('.trashItem input:checked');
    $('#clearTrash').disabled=!isAdmin || !(state.inspectionTrash?.length);
  }

  function renderCalendar(){ const host=$('#yearsHost'); host.innerHTML=''; const today=new Date();
    state.years.sort((a,b)=>a-b).forEach(y=>{
      const det=document.createElement('details'); det.className='card'; det.open=false;
      const sum=document.createElement('summary'); sum.textContent=y; det.appendChild(sum);
      const wrap=document.createElement('div'); wrap.style.padding='6px'; wrap.appendChild(renderYear(y)); det.appendChild(wrap);
      host.appendChild(det);
    });
  }
  function renderYear(Y){ const box=document.createElement('div'); for(let m=0;m<12;m++){ box.appendChild(renderMonth(Y,m)); } return box; }
  function renderMonth(Y,M){ const date=new Date(Y,M,1); const name=date.toLocaleString('default',{month:'long'});
    const cont=document.createElement('div'); cont.style.marginBottom='8px';
    const title=document.createElement('div'); title.style.fontWeight='600'; title.style.margin='6px 0'; title.textContent=name; cont.appendChild(title);
    const header=document.createElement('div'); header.className='grid7'; ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{ const c=document.createElement('div'); c.style.textAlign='center'; c.style.fontSize='12px'; c.style.fontWeight='700'; c.textContent=d; header.appendChild(c); }); cont.appendChild(header);
    const grid=document.createElement('div'); grid.className='grid7'; const first=date.getDay(); const days=new Date(Y,M+1,0).getDate();
    for(let i=0;i<first;i++){ const pad=document.createElement('div'); pad.className='calendar-day'; grid.appendChild(pad); }
    for(let d=1; d<=days; d++){
      const cell=document.createElement('div'); cell.className='calendar-day'; const lbl=document.createElement('div'); lbl.textContent=d; lbl.style.fontWeight='700'; cell.appendChild(lbl);
      const count=countForDate(Y,M+1,d); if(count>0){ const chip=document.createElement('div'); chip.className='count'; chip.textContent=count; cell.appendChild(chip); cell.style.cursor='pointer'; cell.addEventListener('click',()=>openDay(Y,M+1,d)); }
      if(new Date().toDateString()===new Date(Y,M,d).toDateString()) cell.classList.add('today');
      grid.appendChild(cell);
    }
    cont.appendChild(grid); return cont;
  }
  function countForDate(Y,M,D){ const m=mm(M), d=mm(D); let total=0; state.vehicles.forEach(v=>{ const arr=v.inspections?.[Y]?.[m]?.[d]; if(Array.isArray(arr)) total+=arr.length; }); return total; }
  function openDay(Y,M,D){ const m=mm(M), d=mm(D); const list=[]; state.vehicles.forEach(v=>{ const arr=v.inspections?.[Y]?.[m]?.[d]; if(Array.isArray(arr)) arr.forEach(r=>list.push({...r, vehicle:v.name, vehicleId:v.id})); }); list.sort((a,b)=> (a.time||'').localeCompare(b.time||'')); $('#dayTitle').textContent=`${Y}-${m}-${d} ‚Äî ${list.length} inspection${list.length!==1?'s':''}`; const host=$('#dayContent'); host.innerHTML=''; list.forEach(r=>{ const card=document.createElement('div'); card.className='card'; card.innerHTML=`<div style="font-weight:700">${r.date} ${r.time} ‚Äî ${r.type}</div>
      <div class='kv'><div>Inspector</div><div>${r.person||'-'} ${r.org? '('+r.org+')':''}</div>
      <div>Vehicle</div><div>${r.vehicle}</div>
      <div>Mileage</div><div>${r.mileage??'-'} mi</div>
      <div>Fuel</div><div>${r.fuel??'-'}%</div></div>
      <div class='divider'></div>`;
      const checks=document.createElement('div'); checks.style.display='grid'; checks.style.gridTemplateColumns='1fr 1fr'; checks.style.gap='6px'; Object.entries(r.checks||{}).forEach(([k,val])=>{ const lab=document.createElement('label'); lab.style.display='flex'; lab.style.alignItems='center'; lab.style.gap='6px'; const cb=document.createElement('input'); cb.type='checkbox'; cb.disabled=true; cb.checked=!!val; lab.appendChild(cb); lab.appendChild(document.createTextNode(k)); checks.appendChild(lab); }); card.appendChild(checks);
      const photos=document.createElement('div'); photos.className='row'; (r.photos||[]).forEach(src=>{ const img=document.createElement('img'); img.src=src; img.className='thumb'; img.addEventListener('click',()=>{ $('#lightboxImg').src=src; openModal('#lightbox'); }); photos.appendChild(img); }); card.appendChild(photos);
      const adminRow=document.createElement('div'); adminRow.className='row'; adminRow.style.justifyContent='flex-end';
      if(session.role==='admin'){
        const eBtn=document.createElement('button'); eBtn.className='btn btn-primary'; eBtn.textContent='Edit';
        eBtn.addEventListener('click',()=> openEditModal(findInspectionById(r.id)));
        const dBtn=document.createElement('button'); dBtn.className='btn btn-warn'; dBtn.textContent='Delete';
        dBtn.addEventListener('click',()=> deleteInspectionWithConfirm(r.id));
        adminRow.appendChild(eBtn); adminRow.appendChild(dBtn);
      }
      card.appendChild(adminRow);
      host.appendChild(card); }); openModal('#dayModal'); }
  document.getElementById('dayClose').addEventListener('click',()=>closeModal('#dayModal'));
  document.getElementById('lightbox').addEventListener('click',e=>{ if(e.target.id==='lightbox') closeModal('#lightbox'); });

  // Expand/Collapse all years
  document.getElementById('toggleYears').addEventListener('click',()=>{ const btn=$('#toggleYears'); const all=[...document.querySelectorAll('#yearsHost details')]; const anyOpen=all.some(d=>d.open); all.forEach(d=>d.open=!anyOpen); btn.textContent= anyOpen? 'Expand All Years' : 'Collapse All Years'; });

  // Vehicles UI
  let vehDraftPhotos=[], vehDraftName='', vehDraftMileage=0;
  function renderVehicles(){ const host=$('#vehList'); host.innerHTML=''; state.vehicles.forEach((v,i)=>{
    const row=document.createElement('div');
    row.innerHTML=`<div><b>${v.name}</b> <span class="pill">${v.mileage??0} mi</span></div>`;
    const r=document.createElement('div');
    const open=document.createElement('button'); open.className='btn btn-ghost'; open.textContent='Open';
    const edit=document.createElement('button'); edit.className='btn btn-primary'; edit.textContent='Edit';
    const del=document.createElement('button'); del.className='btn btn-warn'; del.textContent='Delete';
    r.appendChild(open); r.appendChild(edit); r.appendChild(del); row.appendChild(r); host.appendChild(row);
    const body=document.createElement('div'); body.className='hidden';
    const gal=document.createElement('div'); gal.className='row'; (v.basePhotos||[]).forEach((src,idx)=>{ const wrap=document.createElement('div'); wrap.style.position='relative'; const img=document.createElement('img'); img.src=src; img.className='thumb'; img.addEventListener('click',()=>{ $('#lightboxImg').src=src; openModal('#lightbox'); }); wrap.appendChild(img); if(session.role==='admin'){ const x=document.createElement('button'); x.className='btn btn-warn'; x.style.position='absolute'; x.style.top='-8px'; x.style.right='-8px'; x.style.padding='2px 6px'; x.textContent='√ó'; x.addEventListener('click',()=>{ if(!confirm('Remove this photo?')) return; v.basePhotos.splice(idx,1); persist().then(renderVehicles); }); wrap.appendChild(x);} gal.appendChild(wrap); }); body.appendChild(gal);
    if(session.role==='admin'){ const up=document.createElement('label'); up.className='btn btn-ghost'; up.textContent='Add Photos'; const file=document.createElement('input'); file.type='file'; file.accept='image/*'; file.multiple=true; file.className='hidden'; up.appendChild(file); file.addEventListener('change', async e=>{ const files=[...e.target.files]; for(const f of files){ v.basePhotos.push(await fileToDataURL(f)); } await persist(); renderVehicles(); }); body.appendChild(up); }
    host.appendChild(body);
    open.addEventListener('click',()=> body.classList.toggle('hidden'));
    edit.addEventListener('click', async ()=>{ if(session.role!=='admin') return; const newName=prompt('Rename vehicle', v.name); if(newName && newName!==v.name){ if(!confirm(`Confirm rename to "${newName}"?`)) return; v.name=newName; }
      const newMiles=prompt('Update mileage', v.mileage??''); if(newMiles!==null && newMiles!==''){ const nm=parseInt(newMiles)||v.mileage; if(nm!==v.mileage){ if(!confirm(`Confirm change mileage to ${nm}?`)) return; v.mileage=nm; } }
      await persist(); renderVehicles(); renderSelects(); renderBrowser(); renderCalendar(); });
    del.addEventListener('click',()=>{ if(session.role!=='admin') return; if(!confirm('Delete vehicle and ALL inspections? This cannot be undone.')) return; state.vehicles.splice(i,1); persist().then(()=>{ renderVehicles(); renderSelects(); renderBrowser(); renderCalendar(); }); });
  }); }
  document.getElementById('vehAdd').addEventListener('click',()=>{ const name=$('#vehName').value.trim(); const miles=parseInt($('#vehMileage').value||'0',10); if(!name) return toast('Enter a vehicle name'); if(state.vehicles.length>=60) return toast('Max 60 vehicles'); vehDraftName=name; vehDraftMileage=isNaN(miles)?0:miles; vehDraftPhotos=[]; $('#vehPhotosInput').value=''; $('#vehPhotosPreview').innerHTML=''; openModal('#vehModal'); });
  document.getElementById('vehCancel').addEventListener('click',()=> closeModal('#vehModal'));
  document.getElementById('vehPhotosInput').addEventListener('change', async e=>{ const files=[...e.target.files]; for(const f of files){ vehDraftPhotos.push(await fileToDataURL(f)); } renderVehDraft(); e.target.value=''; });
  function renderVehDraft(){ const host=$('#vehPhotosPreview'); host.innerHTML=''; vehDraftPhotos.forEach((src,idx)=>{ const wrap=document.createElement('div'); wrap.style.position='relative'; const img=document.createElement('img'); img.src=src; img.className='thumb'; img.addEventListener('click',()=>{ $('#lightboxImg').src=src; openModal('#lightbox'); }); const x=document.createElement('button'); x.className='btn btn-warn'; x.style.position='absolute'; x.style.top='-8px'; x.style.right='-8px'; x.style.padding='2px 6px'; x.textContent='√ó'; x.addEventListener('click',()=>{ vehDraftPhotos.splice(idx,1); renderVehDraft(); }); wrap.appendChild(img); wrap.appendChild(x); host.appendChild(wrap); }); }
  document.getElementById('vehConfirm').addEventListener('click', async ()=>{ if(vehDraftPhotos.length<4) return toast('Need at least 4 photos'); state.vehicles.push({ id:uid(), name:vehDraftName, mileage:vehDraftMileage, basePhotos:[...vehDraftPhotos], inspections:{} }); await persist(); closeModal('#vehModal'); $('#vehName').value=''; $('#vehMileage').value=''; renderVehicles(); renderSelects(); toast('Vehicle created'); });

  // Organizations UI
  function renderOrgs(){ const host=$('#orgList'); host.innerHTML=''; state.orgs.forEach((o,i)=>{ const row=document.createElement('div'); row.style.alignItems='flex-start'; const left=document.createElement('div'); left.innerHTML = `<b>${o.name}</b>`; const middle=document.createElement('div'); middle.className='note'; middle.style.flex='1'; middle.textContent=o.note||''; const right=document.createElement('div');
    const ren=document.createElement('button'); ren.className='btn btn-primary'; ren.textContent='Rename';
    const del=document.createElement('button'); del.className='btn btn-warn'; del.textContent='Delete';
    ren.addEventListener('click', async()=>{ if(session.role!=='admin') return; const newName=prompt('Rename organization', o.name); if(!newName || newName===o.name) return; if(!confirm(`Confirm rename to "${newName}"?`)) return; o.name=newName; await persist(); renderOrgs(); renderSelects(); renderBrowser(); });
    del.addEventListener('click', async()=>{ if(session.role!=='admin') return; if(!confirm('Delete this organization?')) return; state.orgs.splice(i,1); await persist(); renderOrgs(); renderSelects(); });
    right.appendChild(ren); right.appendChild(del); row.appendChild(left); row.appendChild(middle); row.appendChild(right); host.appendChild(row);
    const body=document.createElement('div'); const ta=document.createElement('textarea'); ta.className='field'; ta.placeholder='Optional note for this org'; ta.value=o.note||''; ta.addEventListener('input',()=>{ o.note=ta.value; }); ta.addEventListener('change', async()=>{ if(!confirm('Confirm save note changes?')){ ta.value=o.note||''; return; } await persist(); }); body.appendChild(ta); host.appendChild(body);
  }); }
  document.getElementById('orgAdd').addEventListener('click',()=>{ const name=$('#orgInput').value.trim(); if(!name) return toast('Enter an organization'); if(state.orgs.length>=60) return toast('Max 60 orgs'); if(state.orgs.some(x=>x.name===name)) return toast('Already exists'); state.orgs.push({name, note:''}); persist().then(()=>{ $('#orgInput').value=''; renderOrgs(); renderSelects(); }); });

  // People UI & roles
  function renderPeople(){ const host=$('#peopleList'); host.innerHTML=''; state.people.forEach((p,i)=>{ const row=document.createElement('div'); row.innerHTML=`<div><b>${p.name}</b> <span class="pill">${p.role}</span></div>`; const right=document.createElement('div');
    const ren=document.createElement('button'); ren.className='btn btn-primary'; ren.textContent='Rename';
    const roleSel=document.createElement('select'); roleSel.className='field'; roleSel.style.maxWidth='140px'; roleSel.innerHTML='<option value="user">user</option><option value="admin">admin</option>'; roleSel.value=p.role;
    const del=document.createElement('button'); del.className='btn btn-warn'; del.textContent='Delete';
    ren.addEventListener('click', async()=>{ if(session.role!=='admin') return; const nv=prompt('Rename person', p.name); if(!nv || nv===p.name) return; if(!confirm(`Confirm rename to "${nv}"?`)) return; p.name=nv; await persist(); renderPeople(); renderSelects(); renderLoginSelector(); });
    roleSel.addEventListener('change', async ()=>{ if(session.role!=='admin') return; const newRole=roleSel.value; if(p.name==='Daniels' && newRole!=='admin'){ toast('Daniels must remain admin'); roleSel.value='admin'; return; } if(!confirm(`Confirm change role of ${p.name} to ${newRole}?`)){ roleSel.value=p.role; return; } p.role=newRole; if(p.role==='admin' && !p.passHash){ const pass=prompt('Create admin password for '+p.name); if(!pass) { p.role='user'; roleSel.value='user'; } else { p.passHash=await hash(pass); } } await persist(); renderPeople(); updateRoleUI(); });
    del.addEventListener('click',()=>{ if(p.name==='Daniels') return toast('Cannot remove Daniels'); if(!confirm(`Delete ${p.name}?`)) return; state.people.splice(i,1); persist().then(()=>{ renderPeople(); renderSelects(); renderLoginSelector(); }); });
    right.appendChild(ren); right.appendChild(roleSel); right.appendChild(del);
    row.appendChild(right); host.appendChild(row); }); }
  document.getElementById('personAdd').addEventListener('click',()=>{ const name=$('#personInput').value.trim(); const role=$('#personRole').value; if(!name) return toast('Enter name'); if(state.people.some(x=>x.name===name)) return toast('Exists'); const person={name, role}; state.people.push(person); persist().then(()=>{ $('#personInput').value=''; renderPeople(); renderSelects(); renderLoginSelector(); }); });

  // Inspection Form
  let inspPhotos=[];
  function renderSelects(){ $('#inspYear').innerHTML=state.years.map(y=>`<option>${y}</option>`).join(''); $('#inspVehicle').innerHTML=state.vehicles.map(v=>`<option value="${v.id}">${v.name}</option>`).join(''); $('#inspPerson').innerHTML=state.people.map(p=>`<option>${p.name}</option>`).join(''); $('#inspOrg').innerHTML=state.orgs.map(o=>`<option>${o.name}</option>`).join('');
    // Filters
    $('#filterYear').innerHTML=['All',...state.years].map(y=>`<option>${y}</option>`).join(''); $('#filterVehicle').innerHTML=['All',...state.vehicles.map(v=>v.name)].map(n=>`<option>${n}</option>`).join('');
    // Edit modal selects
    $('#editPerson').innerHTML=state.people.map(p=>`<option>${p.name}</option>`).join('');
    $('#editOrg').innerHTML=state.orgs.map(o=>`<option>${o.name}</option>`).join('');
  }

  function renderChecklistForm(){ const host=$('#checklistForm'); host.innerHTML=''; state.checks.forEach(item=>{ const row=document.createElement('div'); row.className='card'; row.style.padding='8px'; const label=document.createElement('label'); label.style.display='flex'; label.style.alignItems='center'; label.style.gap='6px'; const cb=document.createElement('input'); cb.type='checkbox'; cb.required=true; cb.dataset.label=item.label; label.appendChild(cb); label.appendChild(document.createTextNode(item.label)); row.appendChild(label); if(item.kind==='yn'){ const sel=document.createElement('select'); sel.className='field'; sel.innerHTML='<option value="yes">Yes</option><option value="no">No</option>'; sel.dataset.yn=item.label; sel.style.marginTop='6px'; row.appendChild(sel); } host.appendChild(row); }); }

  document.getElementById('inspPhotos').addEventListener('change', async e=>{ const files=[...e.target.files]; for(const f of files){ inspPhotos.push(await fileToDataURL(f)); } renderInspPhotos(); e.target.value=''; });
  function renderInspPhotos(){ const host=$('#inspPhotoGrid'); host.innerHTML=''; inspPhotos.forEach((src,idx)=>{ const wrap=document.createElement('div'); wrap.style.position='relative'; const img=document.createElement('img'); img.src=src; img.className='thumb'; img.addEventListener('click',()=>{ $('#lightboxImg').src=src; openModal('#lightbox'); }); const x=document.createElement('button'); x.className='btn btn-warn'; x.style.position='absolute'; x.style.top='-8px'; x.style.right='-8px'; x.style.padding='2px 6px'; x.textContent='√ó'; x.addEventListener('click',()=>{ inspPhotos.splice(idx,1); renderInspPhotos(); }); wrap.appendChild(img); wrap.appendChild(x); host.appendChild(wrap); }); }

  document.getElementById('inspType').addEventListener('change', syncTypeDisables);
  function syncTypeDisables(){ const type=$('#inspType').value; const personSel=$('#inspPerson'); const orgSel=$('#inspOrg'); if(type==='Customer-check'){ personSel.disabled=true; if(orgSel.options.length) orgSel.selectedIndex=0; } else { personSel.disabled=false; } }

  document.getElementById('saveInspection').addEventListener('click', async ()=>{
    const vehicleId=$('#inspVehicle').value; const vehicle=state.vehicles.find(v=>v.id===vehicleId); if(!vehicle) return toast('Select a vehicle');
    const year=parseInt($('#inspYear').value,10); const date=$('#inspDate').value; const time=$('#inspTime').value||'00:00'; if(!date) return toast('Pick a date'); if(inspPhotos.length<4) return toast('Need 4 photos');
    const person=$('#inspPerson').value; const org=$('#inspOrg').value; const type=$('#inspType').value; const mileage=parseInt($('#inspMileage').value||''); const fuel=parseInt($('#inspFuel').value||'');
    const checks={}; let allChecked=true; document.querySelectorAll('#checklistForm input[type=checkbox]').forEach(cb=>{ checks[cb.dataset.label]=!!cb.checked; if(!cb.checked) allChecked=false; }); if(!allChecked) return toast('Complete all checklist items');
    document.querySelectorAll('#checklistForm select[data-yn]').forEach(sel=>{ checks[sel.dataset.yn + ' (YN)']=sel.value; });
    const [yyyy,mmStr,ddStr]=date.split('-'); if(!vehicle.inspections[yyyy]) vehicle.inspections[yyyy]={}; if(!vehicle.inspections[yyyy][mmStr]) vehicle.inspections[yyyy][mmStr]={}; if(!vehicle.inspections[yyyy][mmStr][ddStr]) vehicle.inspections[yyyy][mmStr][ddStr]=[];
    const rec={ id:uid(), date, time, type, person: type==='Customer-check'? null : person, org: type==='Customer-check'? org : org||null, mileage:isNaN(mileage)?null:mileage, fuel:isNaN(fuel)?null:fuel, checks, photos:[...inspPhotos] };
    vehicle.inspections[yyyy][mmStr][ddStr].push(rec);
    await persist(); inspPhotos=[]; renderInspPhotos(); renderCalendar(); renderBrowser();
    toast('Inspection saved successfully.'); setTimeout(()=>toast('Inspection submitted.'),1300);
  });

  // Browser
  function renderBrowser(){ const list=$('#browserList'); list.innerHTML=''; let items=[]; const fy=$('#filterYear').value||'All'; const fv=$('#filterVehicle').value||'All'; const q=($('#filterQuery').value||'').toLowerCase();
    state.vehicles.forEach(v=>{ if(fv!=='All' && v.name!==fv) return; Object.entries(v.inspections||{}).forEach(([yr,months])=>{ if(fy!=='All' && String(yr)!==String(fy)) return; Object.entries(months||{}).forEach(([m,days])=>{ Object.entries(days||{}).forEach(([d,arr])=>{ arr.forEach(r=> items.push({...r, vehicle:v.name, vehicleId:v.id, year:+yr})); }); }); }); });
    items.sort((a,b)=> (a.date+a.time).localeCompare(b.date+b.time)); if(q){ items=items.filter(r=> `${r.person||''} ${r.org||''} ${r.type} ${r.vehicle}`.toLowerCase().includes(q)); }
    if(!items.length){ const empty=document.createElement('div'); empty.className='note'; empty.textContent='No inspections match.'; list.appendChild(empty); return; }
    items.forEach(r=>{ const row=document.createElement('div'); row.className='card'; row.style.alignItems='center'; const text=document.createElement('div'); text.style.flex='1'; text.innerHTML=`<div>${r.date} ${r.time} ‚Äî <b>${r.type}</b> ‚Äî ${(r.person||'-')} (${r.org||'-'}) ‚Äî ${r.vehicle} ‚Äî ${(r.mileage??'-')} mi ‚Äî ${(r.fuel??'-')}%</div>`;
      const view=document.createElement('button'); view.className='btn btn-ghost'; view.textContent='View'; view.addEventListener('click',()=>{ const [y,m,d]=r.date.split('-'); openDay(+y,+m,+d); });
      row.appendChild(text); row.appendChild(view);
      if(session.role==='admin'){
        const edit=document.createElement('button'); edit.className='btn btn-primary'; edit.textContent='Edit'; edit.addEventListener('click',()=> openEditModal(findInspectionById(r.id)));
        const del=document.createElement('button'); del.className='btn btn-warn'; del.textContent='Delete'; del.addEventListener('click',()=> deleteInspectionWithConfirm(r.id));
        row.appendChild(edit); row.appendChild(del);
      }
      list.appendChild(row); });
  }

  /***********************
   * Inspection: edit / delete / trash
   ***********************/
  function findInspectionById(id){
    for(const v of state.vehicles){
      for(const [yyyy,months] of Object.entries(v.inspections||{})){
        for(const [mm,days] of Object.entries(months||{})){
          for(const [dd,arr] of Object.entries(days||{})){
            const idx=arr.findIndex(x=>x.id===id);
            if(idx>-1) return {vehicle:v, yyyy, mm, dd, arr, idx, rec:arr[idx]};
          }
        }
      }
    }
    return null;
  }

  // Delete -> move to trash
  async function deleteInspectionWithConfirm(id){
    if(session.role!=='admin') return;
    const ctx=findInspectionById(id);
    if(!ctx) return toast('Record not found');
    if(!confirm('Delete this inspection? It will move to Trash for 35 days.')) return;
    const removed = ctx.arr.splice(ctx.idx,1)[0];
    state.inspectionTrash.push({
      ...removed,
      _meta:{vehicleId:ctx.vehicle.id, yyyy:ctx.yyyy, mm:ctx.mm, dd:ctx.dd},
      deletedAt: Date.now(),
      trashId: uid()
    });
    await persist();
    renderCalendar(); renderBrowser(); renderTrash(); toast('Inspection moved to Trash');
  }

  // Trash UI
  function renderTrash(){
    const list=$('#trashList'); list.innerHTML='';
    const items=[...(state.inspectionTrash||[])].sort((a,b)=> (b.deletedAt - a.deletedAt));
    if(!items.length){ const note=document.createElement('div'); note.className='note'; note.textContent='Trash is empty.'; list.appendChild(note); }
    items.forEach(it=>{
      const row=document.createElement('div'); row.className='list trashItem';
      const inner=document.createElement('div'); inner.style.width='100%'; inner.style.display='flex'; inner.style.justifyContent='space-between'; inner.style.alignItems='center';
      const left=document.createElement('div'); left.innerHTML=`<input type="checkbox" data-tid="${it.trashId}" style="margin-right:8px"> <b>${it.date} ${it.time}</b> ‚Äî ${it.type} ‚Äî ${it.person||'-'} (${it.org||'-'})`;
      const right=document.createElement('div'); right.className='note'; const daysLeft = Math.max(0, 35 - Math.floor((Date.now()-it.deletedAt)/(1000*60*60*24))); right.textContent=`${daysLeft}d left`;
      inner.appendChild(left); inner.appendChild(right); row.appendChild(inner); list.appendChild(row);
    });
    renderTrashIndicator();
    updateTrashAdminButtons();
  }

  function renderTrashIndicator(){
    const count = state.inspectionTrash?.length || 0;
    $('#trashCount').textContent = count;
    const badge = $('#trashIndicator');
    if(count>0){ badge.classList.add('pill-red'); } else { badge.classList.remove('pill-red'); }
  }

  function updateTrashAdminButtons(){
    const isAdmin=session.role==='admin';
    const anySelected = !!document.querySelector('#trashList input[type=checkbox]:checked');
    $('#restoreSelected').disabled = !isAdmin || !anySelected;
    $('#clearTrash').disabled = !isAdmin || !(state.inspectionTrash?.length);
  }

  $('#trashList').addEventListener('change', updateTrashAdminButtons);

  async function cleanupTrash(initial=false){
    const before=state.inspectionTrash?.length||0;
    const cutoff = Date.now() - 35*24*60*60*1000;
    state.inspectionTrash = (state.inspectionTrash||[]).filter(it=> it.deletedAt > cutoff);
    if(!initial && before !== state.inspectionTrash.length){ await persist(); renderTrash(); }
  }

  // periodic cleanup once per day
  setInterval(cleanupTrash, 12*60*60*1000);

  // Restore selected
  document.getElementById('restoreSelected').addEventListener('click', async ()=>{
    if(session.role!=='admin') return;
    const ids=[...document.querySelectorAll('#trashList input[type=checkbox]:checked')].map(c=>c.dataset.tid);
    if(!ids.length) return;
    if(!confirm(`Restore ${ids.length} inspection(s) to their original dates?`)) return;
    for(const tid of ids){
      const idx=state.inspectionTrash.findIndex(x=>x.trashId===tid);
      if(idx===-1) continue;
      const item=state.inspectionTrash.splice(idx,1)[0];
      const meta=item._meta||{};
      const veh=state.vehicles.find(v=>v.id===meta.vehicleId);
      if(!veh) continue;
      if(!veh.inspections[meta.yyyy]) veh.inspections[meta.yyyy]={};
      if(!veh.inspections[meta.yyyy][meta.mm]) veh.inspections[meta.yyyy][meta.mm]={};
      if(!veh.inspections[meta.yyyy][meta.mm][meta.dd]) veh.inspections[meta.yyyy][meta.mm][meta.dd]=[];
      // strip trash metadata
      const { _meta, deletedAt, trashId, ...rest } = item;
      veh.inspections[meta.yyyy][meta.mm][meta.dd].push(rest);
    }
    await persist(); renderTrash(); renderCalendar(); renderBrowser(); toast('Restored.');
  });

  // Clear all trash
  document.getElementById('clearTrash').addEventListener('click', async ()=>{
    if(session.role!=='admin') return;
    if(!(state.inspectionTrash?.length)) return;
    if(!confirm('Permanently delete all items in Trash? This cannot be undone.')) return;
    state.inspectionTrash=[];
    await persist(); renderTrash(); toast('Trash cleared.');
  });

  /***********************
   * Edit modal behavior
   ***********************/
  let editingCtx=null;
  function openEditModal(ctx){
    if(!ctx || session.role!=='admin') return;
    editingCtx=ctx;
    $('#editDate').value=ctx.rec.date;
    $('#editTime').value=ctx.rec.time||'';
    $('#editType').value=ctx.rec.type||'Pre-check';
    $('#editPerson').value=ctx.rec.person||'';
    $('#editOrg').value=ctx.rec.org||'';
    $('#editMileage').value=ctx.rec.mileage??'';
    $('#editFuel').value=ctx.rec.fuel??'';
    syncEditTypeDisables();
    openModal('#editModal');
  }
  function syncEditTypeDisables(){
    const type=$('#editType').value;
    const personSel=$('#editPerson'), orgSel=$('#editOrg');
    if(type==='Customer-check'){ personSel.disabled=true; } else { personSel.disabled=false; }
  }
  document.getElementById('editType').addEventListener('change', syncEditTypeDisables);
  document.getElementById('editCancel').addEventListener('click', ()=> closeModal('#editModal'));
  document.getElementById('editSave').addEventListener('click', async ()=>{
    if(!editingCtx) return;
    if(!confirm('Confirm save changes to this inspection?')) return;
    const newDate=$('#editDate').value;
    const newTime=$('#editTime').value||'';
    const newType=$('#editType').value;
    const newPerson = newType==='Customer-check' ? null : $('#editPerson').value||null;
    const newOrg = newType==='Customer-check' ? $('#editOrg').value : ($('#editOrg').value||null);
    const newMileage=parseInt($('#editMileage').value||'');
    const newFuel=parseInt($('#editFuel').value||'');
    // if date changed, move
    if(newDate !== editingCtx.rec.date){
      // remove from old array
      editingCtx.arr.splice(editingCtx.idx,1);
      const [yyyy,mm,dd]=newDate.split('-');
      const veh=editingCtx.vehicle;
      veh.inspections[yyyy] = veh.inspections[yyyy] || {};
      veh.inspections[yyyy][mm] = veh.inspections[yyyy][mm] || {};
      veh.inspections[yyyy][mm][dd] = veh.inspections[yyyy][mm][dd] || [];
      editingCtx.rec.date=newDate;
      editingCtx.rec.time=newTime;
      editingCtx.rec.type=newType;
      editingCtx.rec.person=newPerson;
      editingCtx.rec.org=newOrg;
      editingCtx.rec.mileage=isNaN(newMileage)?editingCtx.rec.mileage:newMileage;
      editingCtx.rec.fuel=isNaN(newFuel)?editingCtx.rec.fuel:newFuel;
      veh.inspections[yyyy][mm][dd].push(editingCtx.rec);
    } else {
      editingCtx.rec.time=newTime;
      editingCtx.rec.type=newType;
      editingCtx.rec.person=newPerson;
      editingCtx.rec.org=newOrg;
      editingCtx.rec.mileage=isNaN(newMileage)?editingCtx.rec.mileage:newMileage;
      editingCtx.rec.fuel=isNaN(newFuel)?editingCtx.rec.fuel:newFuel;
    }
    await persist(); renderBrowser(); renderCalendar(); closeModal('#editModal'); toast('Inspection updated.');
  });

  /***********************
   * Backup / Restore (admin only)
   ***********************/
  document.getElementById('backupBtn').addEventListener('click', async ()=>{ if(session.role!=='admin') return toast('Admin only'); const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='rvm-backup.json'; a.click(); URL.revokeObjectURL(url); });
  document.getElementById('restoreInput').addEventListener('change', async e=>{ if(session.role!=='admin') return toast('Admin only'); const f=e.target.files?.[0]; if(!f) return; try{ const text=await f.text(); const data=JSON.parse(text); state=data; if(!state.inspectionTrash) state.inspectionTrash=[]; await cleanupTrash(true); await persist(); renderAll(); toast('Restore complete'); }catch{ toast('Invalid file'); } e.target.value=''; });

  /***********************
   * Login Flow
   ***********************/
  function renderLoginSelector(){ const mode=document.querySelector('input[name=loginMode]:checked').value; const sel=$('#loginSelector'); if(mode==='personnel'){ sel.innerHTML=state.people.map(p=>`<option>${p.name}</option>`).join(''); } else { sel.innerHTML=state.orgs.map(o=>`<option>${o.name}</option>`).join(''); } }
  document.querySelectorAll('input[name=loginMode]').forEach(r=> r.addEventListener('change', renderLoginSelector));
  document.getElementById('loginBtn').addEventListener('click', async ()=>{ const mode=document.querySelector('input[name=loginMode]:checked').value; const name=$('#loginSelector').value; const pass=$('#loginPassword').value;
    if(mode==='personnel'){
      const person=state.people.find(p=>p.name===name);
      if(!person) return toast('Select a person');
      if(person.name==='Daniels'){ const ok = pass===PW.danielsAdmin; if(!ok) return toast('Wrong password'); session.user=person.name; session.role='admin'; closeModal('#loginModal'); updateRoleUI(); toast('Welcome Daniels'); return; }
      if(person.role==='admin'){
        if(!person.passHash){ const newPass=prompt('Set password (first-time admin login)'); if(!newPass) return; person.passHash=await hash(newPass); await persist(); }
        const okHash=await hash(pass); if(okHash!==person.passHash) return toast('Wrong password'); session.user=person.name; session.role='admin'; closeModal('#loginModal'); updateRoleUI(); toast('Admin login'); return;
      } else {
        if(pass!==PW.personnel) return toast('Wrong password'); session.user=person.name; session.role='user'; closeModal('#loginModal'); updateRoleUI(); toast('User login'); return;
      }
    } else {
      if(pass!==PW.org) return toast('Wrong password'); session.user=name; session.role='org'; closeModal('#loginModal'); updateRoleUI(); toast('Organization login'); return;
    }
  });

  /***********************
   * Init & render all
   ***********************/
  function renderAll(){ renderCalendar(); renderVehicles(); renderOrgs(); renderPeople(); renderSelects(); renderChecklistForm(); renderBrowser(); renderLoginSelector(); syncTypeDisables(); renderTrash(); }

  // Minimal sanity tests
  function runSanityTests(){
    try { document.querySelectorAll('#tabs .tabbtn')[1].click(); document.querySelectorAll('#tabs .tabbtn')[0].click(); console.log('Tab toggle smoke test passed'); } catch(e){ console.error('Tab toggle test failed', e); }
    try { const dan=state.people.find(p=>p.name==='Daniels'); console.assert(dan && typeof dan.passHash==='string', 'Daniels passHash must be a string'); console.log('Seed/admin test passed'); } catch(e){ console.error('Seed/admin test failed', e); }
  }

  (async function bootstrap(){ await loadState(); renderAll(); runSanityTests(); })();

  </script>
</body>
</html>
